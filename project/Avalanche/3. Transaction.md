# 📝 Transaction

트랜잭션은 1)priority fee 높은 순 2) 오래된 순 으로 정렬됨

참고 : [https://docs.avax.network/reference/standards/guides/txn-fees](https://docs.avax.network/reference/standards/guides/txn-fees)

## raw data
### getBlock
```json
{

"_comment": "getBlock",
"baseFeePerGas": "25000000000n",
"difficulty": "1n",
"extraData": "0x00000000000000000000000000000000000000000001d494000000000000000000000000000aae810000000000115b520000000000000000000000000012eec700000000000000000000000000000000000000000000",
"gasLimit": "15000000n",
"gasUsed": "1240907n",
"hash": "0xa1a36de8e1f6c1bce8162a9a44367453c03815abfebc82107353701a90c5d881",
"logsBloom": "0x0008000800000000000000a000000000004000001000040000004000004000000000000000800000000000000108000000001000400000000080180000000000400030000800000000000008002000000000000000000000000000000000000000000000020000108000000000800800000000001000000044000010400000000042000000000000000000800000001000000800000000000000000000000008000000000024000000400000000010000000000000000010000000002000000200014002000080000020004000000000000000000000000000000100000020080000000000100000000404022000000000000000001000000000100000004008",
"miner": "0x0100000000000000000000000000000000000000",
"mixHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
"nonce": "0n",
"number": "33181969n",
"parentHash": "0xc8e2e4124a1e6763c517504b3d6dd7553d6e1d4d70303c5e3590c5e8c83f4cb4",
"receiptsRoot": "0x4b1e510ac8ee08c0d72377a0db4295ba499213ccfe696cd51a709f36a535b3f3",
"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
"size": "5238n",
"stateRoot": "0x8313443b79c7bf53b38c0fb24afb699467f6b311a6a64ad03173ab7a51e6ca05",
"timestamp": "1716200529n",
"totalDifficulty": "33181969n",
"transactions": [
"0x0c6178cb0499f148f2bad80a856da387dbe8ef5a0b0ff4bfd8f612ebacffec91",
"0x0d249be010618c1780a0b7fbf92707e57cdf63489b080108527dc88efb44c995",
"0x43e884863073d512a557ba08e4dab5c084365979ca96b2a4ce3db6b0ef0ea6a8",
"0x671f0dae7e425339311526828aa6c462e1e290f4c551bccc2b34d80a40929d3b",
"0x60dc681dd5561e5ed15c9864073f89f18fc6952bf30e9d8a14925562833f4768",
"0xe233702f066a249fe1c271b0ecebe39441f8a418495831cf78d3cde9fa4094b3",
"0xd17ca289079ba820247f596ed086eefabde270883fb3de67552f3a2727384666"
],
"transactionsRoot": "0xd61084135cdbd8e3b0c22862a24d7b72304db45b53eda806060cb66a4e6d51c4",
"uncles": []
},
```
### getTransaction

```javascript
const rawTx = await this.web3.eth.getTransaction(txHash, {
number: FMT_NUMBER.STR,
bytes: FMT_BYTES.HEX,
});
```
#### case 1) avax
from -> to 로 value 만큼 avax 전송.
input 필드 값이 비어있음 (0x)
```json
{
"_comment": "getTransaction - type: avax-transfer",
"blockHash": "0x93940700ee6cd0e9e60a300329214cbeb19d71b2f23b461394f70310e6193d9c",
"blockNumber": "33047365",
"from": "0x2946a0c0ffe94fe6273881278f8829ac373ae231",
"gas": "21000n",
"gasPrice": "31550463595",
"maxFeePerGas": "31550463595",
"maxPriorityFeePerGas": "6650000000",
"hash": "0xdc334146c581204d1070b08d76b14034a7cbd4331110f2ae07cf15b063b84d0d",
"input": "0x",
"nonce": "5",
"to": "0x0e00c33c0b5c5084f408c0e3222c48cd1cd66568",
"transactionIndex": "0",
"value": "100000000000000000",
"type": "2",
"accessList": [],
"chainId": "43113",
"v": "1",
"r": "0x62aea5bdd3fa0de6df74ccfad7d7d8ada3c7409723abdd0a1808dc3f68bbf985",
"s": "0x4d27ede41165184910328facdf30a4ab08b1eac7dc17f01f954e349e7c61b0a8",
"data": "0x"
},
```

#### case 2) token
- 토큰 생성 트랜잭션 인 경우, 
  to 필드가 비어있고 input 필드에 해당 컨트랙트 정보가 들어감.
- 토큰 전송 트랜잭션 인 경우,
  to 필드에 해당 컨트랙트 주소가, input 필드에 호출된 컨트랙트 함수 정보가 저장
```json
{
"_comment": "getTransaction - type: erc20-transfer",
"blockHash": "0xc4bddbaa82d954b9098eb0fdef690681b139f4f8f0778cce50c434bc46bc4489",
"blockNumber": "33218881n",
"from": "0x3432deff56c3d6e1883d0a5c8243c11da01257c8",
"gas": "200000n",
"gasPrice": "26000000000n",
"maxFeePerGas": "51000000000n",
"maxPriorityFeePerGas": "1000000000n",
"hash": "0x3ca420caab0b261317be6ceddf701698c943a8e1e126b1afcec4ef83f41b55b4",
"input": "0x87d28cd60000000000000000000000008a30280c6e894e176805ec60a814f1df1b81e96400000000000000000000000007a97eee4395463b9ed8e5c67e638e4febe7e10b0000000000000000000000000a23c47ece388c67ace5d73ec3f64aab3ec6ea2700000000000000000000000000000000000000000000006c6b935b8bbd4000000000000000000000000000003432deff56c3d6e1883d0a5c8243c11da01257c800000000000000000000000000000000000000000000000000000000009896800000000000000000000000000000000000000000000000000000018f9a2e8c6b00000000000000000000000000000000000000000000000000000000664c8de4000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000414d04abe4439b4f2403786714a6c7702975a7db46eed4ec2efe9a3667f55debb87c147b6b22a23a912d73bc568ae153cafeac05186827039b7fe353b7702ae75b1b00000000000000000000000000000000000000000000000000000000000000",
"nonce": "3466n",
"to": "0xbaffb84601bec1fcb4b842f8917e3ea850781be7",
"transactionIndex": " 0n",
"value": "0n",
"type": " 2n",
"accessList": [],
"chainId": "43113n",
"v": "0n",
"r": "0x2099564635e719c54ecc20579a90cb6d84820d8b730bb0fdfcde0943d42d5cec",
"s": "0x7c6626bc530c63c910d9c79fdb9adfef71c6f2a8fb0385b2b6c2803051dce581",
"data": "0x87d28cd60000000000000000000000008a30280c6e894e176805ec60a814f1df1b81e96400000000000000000000000007a97eee4395463b9ed8e5c67e638e4febe7e10b0000000000000000000000000a23c47ece388c67ace5d73ec3f64aab3ec6ea2700000000000000000000000000000000000000000000006c6b935b8bbd4000000000000000000000000000003432deff56c3d6e1883d0a5c8243c11da01257c800000000000000000000000000000000000000000000000000000000009896800000000000000000000000000000000000000000000000000000018f9a2e8c6b00000000000000000000000000000000000000000000000000000000664c8de4000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000414d04abe4439b4f2403786714a6c7702975a7db46eed4ec2efe9a3667f55debb87c147b6b22a23a912d73bc568ae153cafeac05186827039b7fe353b7702ae75b1b00000000000000000000000000000000000000000000000000000000000000"
},
```

#### Nonce
- 특정 주소에서 보내는 트랜잭션에 할당된 번호로, 거래 전송 시마다 nonce 값이 1씩 증가하며, 한 주소에 동일한 nonce를 갖는 트랜잭션은 존재하지 않는다.
- nonce는 순차적으로 증가되고 처리된다. (역행 불가)
### getTransactionReceipt

```javascript
const receipt = await this.web3.eth.getTransactionReceipt(txHash, {
number: FMT_NUMBER.STR,
bytes: FMT_BYTES.HEX,
});
```
\
Transaction Fee : effectiveGasPrice * gasUsed
#### case1) avax
```json
{
  blockHash: '0xb6fca376d8cdc672e89d44c9e2cd6895c5d28ee801be5696d2e236efdf46b496',
  blockNumber: '33411445',
  cumulativeGasUsed: '21000',
  effectiveGasPrice: '100000000000',
  from: '0xb349e271d3cfef2c6d8a5f6feec2343dd0459129',
  gasUsed: '21000',
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: '1',
  to: '0xb9cbb01a6b41795853067e1f2fdc2159b4239763',
  transactionHash: '0x4db4e274cfd670359096e8e43383655086bfd0c9d04fc19523cf3b5f79e05fa7',
  transactionIndex: '0',
  type: '0'
}
```

#### case 2) token
##### ERC-20
to: contract address 
```json
{
  blockHash: '0xa109bd5c876aa6458beea96531bcf3f2e73168fefee0da46f37855be45914596',
  blockNumber: '33283246',
  cumulativeGasUsed: '34448',
  effectiveGasPrice: '26500000000',
  from: '0xdff7e4edcf3f8a80114c6f8420402b1587ae3000',
  gasUsed: '34448',
  logs: [
    {
      address: '0xd00ae08403b9bbb9124bb305c09058e32c39a48c',
      topics: [Array],
      data: '0x0000000000000000000000000000000000000000000000000de0b6b3a7640000',
      blockNumber: '33283246',
      transactionHash: '0x14b173f86ca44de3f127e9b29799f60f6da8d7cb86ceb4d2773d7999153fa005',
      transactionIndex: '0',
      blockHash: '0xa109bd5c876aa6458beea96531bcf3f2e73168fefee0da46f37855be45914596',
      logIndex: '0',
      removed: false
    }
  ],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000008000020000000000010000000000000000000000000000000000020000200020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000002000000000000000000000000000000000000000000000020000000000000000000000000080000000000000000000000000000000000000000000000',
  status: '1',
  to: '0xd00ae08403b9bbb9124bb305c09058e32c39a48c',
  transactionHash: '0x14b173f86ca44de3f127e9b29799f60f6da8d7cb86ceb4d2773d7999153fa005',
  transactionIndex: '0',
  type: '2'
}
```

logs: event log
`topics` : Event에 `indexed`로 선언된 `parameter`들이 여기 담긴다.
`topics`의 `0`번 째 데이터는 event 정의를 해싱한 값이다. `parameter`들은 그 뒤로 인덱싱된다.
`indexed` 로 선언되지 않은 값은 `data`에 abi-encoded 되어있다.

Transfer(address,address,uint256) 를 keccak256으로 해시 생성하면 
`topics[0] === "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"`.  
`topics[1]` : from 주소  
`topics[2]` : to 주소

```json
logs :
[
  {
    address: '0xd00ae08403b9bbb9124bb305c09058e32c39a48c',
    topics: [
    '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef',
      '0x000000000000000000000000dff7e4edcf3f8a80114c6f8420402b1587ae3000',
      '0x000000000000000000000000dcd8034b880ae80217c3523fbbab98a68d772156'
    ],
    data: '0x0000000000000000000000000000000000000000000000000de0b6b3a7640000',
    blockNumber: '33283246',
    transactionHash: '0x14b173f86ca44de3f127e9b29799f60f6da8d7cb86ceb4d2773d7999153fa005',
    transactionIndex: '0',
    blockHash: '0xa109bd5c876aa6458beea96531bcf3f2e73168fefee0da46f37855be45914596',
    logIndex: '0',
    removed: false
  }
]
```

#####  ERC-721
ERC20과 721의 이벤트 함수 같음 (topic[0])
ERC-20 의 경우 topics의 길이가 3 인 반면 ERC-721은 topics의 길이가 4 
topic 길이로 구분 가능

### ERC-165

```javascript
async supportsInterface(contractAddress, interfaceId) {
	const contract = new this.web3.eth.Contract(ERC165_ABI, contractAddress);
	try {
		return await contract.methods.supportsInterface(interfaceId).call();
	} catch (error) {
	return false;
	}
}

const ERC721_INTERFACE_ID = "0x80ac58cd";
const ERC1155_INTERFACE_ID = "0xd9b67a26";
try {
if (await this.supportsInterface(contractAddress, ERC721_INTERFACE_ID)) {
return await this.getERC721Data(contractAddress, tokenId);
} else if (
await this.supportsInterface(contractAddress, ERC1155_INTERFACE_ID)
) {
return await this.getERC1155Data(contractAddress, tokenId);
} else {
return await this.getERC20Data(contractAddress);
}

} catch (error) {

return;

}
```


참고 : 
https://taeyonghwang.github.io/ethereum/ethereum-transaction/
https://tech.ozys.io/2022/02/16/contract-monitoring.html
https://ethereum.org/en/developers/docs/standards/tokens/erc-20/?ref=ansubin.com
